name: Run mega-nz.yaml for each link

on:
  workflow_dispatch:
    inputs:
      mega_urls:
        description: 'MEGA.nz URLs to download (up to 5, separated by commas or spaces)'
        required: true

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        shell: bash
        run: |
          # Replace commas with spaces, then split on spaces
          URLS=$(echo "${{ github.event.inputs.mega_urls }}" | tr ',' ' ')
          matrix="["
          first=true
          for url in $URLS; do
            # Skip empty entries (if any)
            if [ -z "$url" ]; then
              continue
            fi
            if [ "$first" = true ]; then
              first=false
            else
              matrix+=","
            fi
            # Escape quotes if needed
            escaped_url=$(echo "$url" | sed 's/"/\\"/g')
            matrix+="{\"mega_urls\":\"$escaped_url\"}"
          done
          matrix+="]"
          # Strip whitespace/newlines from the JSON string
          matrix_clean=$(echo "$matrix" | tr -d '[:space:]')
          echo "matrix=$matrix_clean" >> $GITHUB_OUTPUT

  run-mega-nz:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    steps:
      - name: Call mega-nz.yaml workflow
        uses: ./.github/workflows/mega-nz.yaml
        with:
          mega_urls: ${{ matrix.mega_urls }}
